#!/usr/bin/ruby
require 'atk_toolbox'

# TODO: look into https://piotrmurach.github.io/tty/  to animate the terminal
# TODO: look at https://github.com/pazdera/catpix to add an ATK logo in the terminal

def get_repo_url(package_name)
    # if its starts with "atk/", just remove that part
    package_name.sub!( /atk\//, "" )
    # if the package name does not have a slash in it, then assume it is a core / approved installer
    if not (package_name =~ /.*\/.*/)
        path_to_core_listing = HOME/"atk"/"core.yaml"
        core = YAML.load_file(path_to_core_listing)
        if core[package_name] != nil
            puts "I don't see that package in the core, let me make sure I have the latest info"
            download("https://raw.githubusercontent.com/aggie-tool-kit/atk/master/interface/core.yaml", as: path_to_core_listing)
            core = YAML.load_file(path_to_core_listing)
        end
        if core[package_name] != nil
            repo_url = core[package_name]["source"]
        else
            raise "That package doesn't seem to be a core package"
        end
    # if it does have a slash, then assume its a github repo
    else
        repo_url = "https://github.com/"+package_name
    end
end

def install(package_name)
    # TODO: split up the package name from the version
    
    # check for an internet connection
    if not online?()
        puts "\n\nIt seems like you're not online at the moment so I can't install anything"
        return
    end
    
    repo_url = get_repo_url(package_name)
    # clone it to the location
    Git.clone(repo_url, HOME/"atk"/package_name)
    
    # check if the package is alread installed
        # ask if they want to reinstall/update it
    # parse the (installer) field to get OS specific settings
    # TODO: recursively check all of the dependencies
        # install the ones they don't have
        # tell them about the ones that are newer
        # ask them to upgrade the ones that are older
    # run the (install_command)
end

if ARGV.length == 0
    puts "This is the ATK command! I'm glad to see you're using it.\nRunning it with no arguments will just get you this message :)"
# if one argument, then act like grep
else
    case ARGV[0]
        when 'update'
            if ARGV[1] == nil
                if OS.is?('mac')
                    -'eval `curl -L git.io/fjBzd`'
                else
                    raise "OS not yet supported for this command"
                end
            end
        when 'install'
            package_name = ARGV[1]
            # load the core packages
            
            # first check the locally-stored core listing
            # then check the locally-stored main listing
            # then search github for the repo
            
            # once a package is found, save it locally and run it's installer
        when 'uninstall'
            # check to see if the package is installed, and check if it has an uninstaller
        when 'new'
            case ARGV[1]
                when 'project'
                    # create a folder with an info.yaml
                    # ask the user what structure's they would like to integrate
                when 'package'
                    # ask the user what kind of package, installer or structure
                when 'installer'
                    # ask the user what they did to install it
                        # just commands
                        # programming logic
                        # manual setup
                    # repeat for each OS
                when 'structure'
                    # TODO: this is a future feature
                    # structures will can have a
                        # verifier (make sure the structe alread exists)
                        # implementer (make the structure exist if it doesnt)
            end
    end
    
end
